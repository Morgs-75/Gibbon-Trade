<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Gibbon Trade - Flooring Supplier Price Comparison</title>
    <style>
        :root {
            --bg: #0f172a;
            --surface: #1e293b;
            --surface2: #334155;
            --border: #475569;
            --text: #e2e8f0;
            --text-muted: #94a3b8;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --green: #22c55e;
            --red: #ef4444;
            --orange: #f59e0b;
            --kevmor: #f97316;
            --intafloors: #06b6d4;
            --gibbon: #22c55e;
            --marques: #a855f7;
            --floortrade: #ec4899;
            --gluesntools: #eab308;
            --homely: #14b8a6;
        }
        [data-theme="light"] {
            --bg: #f8fafc;
            --surface: #ffffff;
            --surface2: #f1f5f9;
            --border: #e2e8f0;
            --text: #020617;
            --text-muted: #334155;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
        }
        body {
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
        }
        .container { max-width: 1500px; margin: 0 auto; padding: 0 1rem; }

        /* Header */
        header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(12px);
        }
        header .container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 0.75rem;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }
        .logo-icon {
            width: 32px; height: 32px;
            background: linear-gradient(135deg, var(--accent), var(--green));
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 900; font-size: 1.1rem; color: white;
        }
        h1 { font-size: 1.2rem; font-weight: 700; }
        h1 .subtitle { color: var(--text-muted); font-weight: 400; font-size: 0.8rem; display: block; line-height: 1.1; }

        .controls {
            display: flex; align-items: center; gap: 0.6rem; flex-wrap: wrap;
        }
        input[type="text"], select {
            background: var(--surface2); border: 1px solid var(--border);
            color: var(--text); padding: 0.45rem 0.7rem;
            border-radius: 6px; font-size: 0.85rem; outline: none;
        }
        input[type="text"]:focus, select:focus { border-color: var(--accent); }
        input[type="text"] { width: 200px; }
        .slider-group {
            display: flex; align-items: center; gap: 0.4rem;
            font-size: 0.8rem; color: var(--text-muted);
        }
        .slider-group input[type="range"] { width: 80px; accent-color: var(--accent); }

        /* Supplier dropdown */
        .supplier-dropdown {
            position: relative;
            display: inline-block;
        }
        .supplier-dropdown-button {
            background: var(--surface2);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.5rem 0.8rem;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 200px;
            justify-content: space-between;
        }
        .supplier-dropdown-button:hover {
            border-color: var(--accent);
        }
        .supplier-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 0.25rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            min-width: 220px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            max-height: 400px;
            overflow-y: auto;
        }
        .supplier-dropdown-menu.active {
            display: block;
        }
        .supplier-option {
            padding: 0.6rem 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-size: 0.85rem;
            transition: background 0.15s;
        }
        .supplier-option:hover {
            background: var(--surface2);
        }
        .supplier-checkbox {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .supplier-checkbox.checked {
            background: var(--accent);
            border-color: var(--accent);
        }
        .supplier-checkbox.checked::after {
            content: '‚úì';
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        .supplier-label {
            flex: 1;
        }

        /* Stats bar */
        .stats-bar {
            display: flex; gap: 0.75rem; padding: 0.75rem 1rem;
            margin: 0.75rem 0; background: var(--surface);
            border-radius: 8px; flex-wrap: wrap;
        }
        .stat { text-align: center; flex: 1; min-width: 100px; }
        .stat-value { font-size: 1.3rem; font-weight: 700; }
        .stat-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }

        /* Tabs */
        .tabs {
            display: flex; gap: 0.2rem; margin: 0.75rem 0 0.4rem;
            border-bottom: 1px solid var(--border);
        }
        .tab {
            padding: 0.45rem 0.9rem; border: none; background: none;
            color: var(--text-muted); cursor: pointer; font-size: 0.85rem;
            font-weight: 500; border-bottom: 2px solid transparent; transition: all 0.15s;
        }
        .tab:hover { color: var(--text); }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        .tab .badge {
            background: var(--surface2); padding: 0.1rem 0.45rem;
            border-radius: 10px; font-size: 0.72rem; margin-left: 0.3rem;
        }
        .tab.active .badge { background: var(--accent); color: white; }

        /* Table styles */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            max-width: 100%;
            position: relative;
            margin-top: 0.5rem;
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 1.5rem;
        }
        th {
            background: var(--surface2);
            padding: 0.6rem 0.5rem;
            font-size: 0.72rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        td {
            padding: 0.55rem 0.5rem;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
            font-size: 0.85rem;
        }
        tbody tr:hover td {
            background: rgba(59,130,246,0.04);
        }
        tbody tr:hover td[style*="position:sticky"] {
            background: rgba(59,130,246,0.08);
        }

        .product-cell { display: flex; align-items: flex-start; gap: 0.6rem; }
        .product-img {
            width: 44px; height: 44px; object-fit: contain;
            border-radius: 4px; background: white; flex-shrink: 0;
        }
        .product-name { font-weight: 600; font-size: 0.82rem; line-height: 1.3; }
        .product-name a { color: var(--text); text-decoration: none; }
        .product-name a:hover { color: var(--accent); text-decoration: underline; }
        .product-category { font-size: 0.72rem; color: var(--text-muted); margin-top: 0.1rem; }

        .price { font-weight: 700; font-size: 0.95rem; white-space: nowrap; }
        .price-na { color: var(--text-muted); font-weight: 400; font-size: 0.78rem; }
        .price-cheaper { color: var(--green); }
        .price-dearer { color: var(--red); }

        .match-score {
            display: inline-block; padding: 0.12rem 0.45rem;
            border-radius: 4px; font-size: 0.72rem; font-weight: 600;
        }
        .score-high { background: rgba(34,197,94,0.2); color: var(--green); }
        .score-medium { background: rgba(245,158,11,0.2); color: var(--orange); }
        .score-low { background: rgba(239,68,68,0.2); color: var(--red); }

        .diff-cell { text-align: center; }
        .diff-amount { font-weight: 700; font-size: 0.88rem; }
        .diff-pct { font-size: 0.72rem; color: var(--text-muted); }

        .source-tag {
            display: inline-block; padding: 0.1rem 0.4rem;
            border-radius: 3px; font-size: 0.68rem; font-weight: 600;
            text-transform: uppercase;
        }
        .source-kevmor { background: rgba(249,115,22,0.2); color: var(--kevmor); }
        .source-intafloors { background: rgba(6,182,212,0.2); color: var(--intafloors); }
        .source-gibbon { background: rgba(34,197,94,0.2); color: var(--gibbon); }
        .source-marques { background: rgba(168,85,247,0.2); color: var(--marques); }
        .source-floortrade { background: rgba(236,72,153,0.2); color: var(--floortrade); }
        .source-gluesntools { background: rgba(234,179,8,0.2); color: var(--gluesntools); }
        .source-homely { background: rgba(20,184,166,0.2); color: var(--homely); }

        .empty-state {
            text-align: center; padding: 3rem 2rem; color: var(--text-muted);
        }
        .empty-state h2 { font-size: 1.15rem; margin-bottom: 0.4rem; color: var(--text); }

        .timestamp {
            font-size: 0.85rem;
            color: var(--text);
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .timestamp-icon {
            font-size: 1.2rem;
        }
        .timestamp-text {
            flex: 1;
        }
        .timestamp-label {
            font-weight: 600;
            margin-right: 0.5rem;
        }
        .timestamp-value {
            color: var(--text-muted);
        }
        .scrape-status {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        .status-success {
            background: rgba(34, 197, 94, 0.2);
            color: var(--green);
        }
        .status-error {
            background: rgba(239, 68, 68, 0.2);
            color: var(--red);
        }

        .loading {
            display: flex; align-items: center; justify-content: center;
            padding: 4rem; gap: 0.75rem; color: var(--text-muted);
        }
        .spinner {
            width: 20px; height: 20px;
            border: 2px solid var(--accent); border-top-color: transparent;
            border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Comparison row - multi-supplier */
        .supplier-prices {
            display: flex; flex-direction: column; gap: 0.3rem;
        }
        .supplier-price-row {
            display: flex; align-items: center; gap: 0.5rem;
        }
        .supplier-dot {
            width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
        }
        .supplier-price-name {
            font-size: 0.75rem; color: var(--text-muted); min-width: 70px;
        }
        .best-price { background: rgba(34,197,94,0.1); border-radius: 4px; padding: 0.1rem 0.3rem; }

        /* Refresh modal */
        .modal-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.6); z-index: 200;
            align-items: center; justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 12px; padding: 1.5rem; width: 320px;
            text-align: center;
        }
        .modal h3 { margin-bottom: 0.75rem; font-size: 1rem; }
        .modal input[type="password"] {
            background: var(--surface2); border: 1px solid var(--border);
            color: var(--text); padding: 0.6rem; border-radius: 6px;
            font-size: 1.2rem; text-align: center; width: 140px;
            letter-spacing: 0.3em; outline: none;
        }
        .modal input[type="password"]:focus { border-color: var(--accent); }
        .modal-btns { display: flex; gap: 0.5rem; justify-content: center; margin-top: 1rem; }
        .btn {
            padding: 0.45rem 1rem; border: none; border-radius: 6px;
            font-size: 0.85rem; font-weight: 600; cursor: pointer;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
        .btn-ghost:hover { background: var(--surface2); }
        .refresh-btn, .nav-btn {
            background: var(--surface2); border: 1px solid var(--border);
            color: var(--text-muted); padding: 0.4rem 0.7rem;
            border-radius: 6px; font-size: 0.78rem; cursor: pointer;
            text-decoration: none; display: inline-block;
        }
        .refresh-btn:hover, .nav-btn:hover { border-color: var(--accent); color: var(--text); }
        .modal-msg { font-size: 0.82rem; margin-top: 0.75rem; min-height: 1.2em; }
        .msg-ok { color: var(--green); }
        .msg-err { color: var(--red); }

        @media (max-width: 768px) {
            .controls { width: 100%; }
            input[type="text"] { width: 100%; flex: 1; }
            .product-img { width: 36px; height: 36px; }
            th, td { padding: 0.4rem 0.3rem; font-size: 0.78rem; }
        }
    </style>
</head>
<body>

<header>
    <div class="container">
        <div class="logo">
            <div class="logo-icon">GT</div>
            <h1>Gibbon Trade<span class="subtitle">Flooring Supplier Comparison</span></h1>
        </div>
        <div class="controls">
            <div class="supplier-dropdown">
                <button class="supplier-dropdown-button" onclick="toggleDropdown(event)">
                    <span id="supplier-count">All Suppliers (7)</span>
                    <span>‚ñº</span>
                </button>
                <div class="supplier-dropdown-menu" id="supplier-menu">
                    <!-- Suppliers will be loaded dynamically from database -->
                </div>
            </div>
            <input type="text" id="search" placeholder="Search products..." oninput="debounceRender()">
            <div class="slider-group">
                <label for="threshold">Match:</label>
                <input type="range" id="threshold" min="25" max="80" value="50" oninput="updateThresholdLabel()" onchange="renderAll()">
                <span id="threshold-label">50%</span>
            </div>
            <a href="fixed.html" class="nav-btn">üí∞ Fixed Pricing</a>
            <a href="insights.html" class="nav-btn">üìä Insights</a>
            <a href="manage-suppliers.html" class="nav-btn">üè™ Suppliers</a>
            <button class="nav-btn" onclick="toggleTheme()" id="theme-toggle" title="Toggle light/dark mode">
                <span id="theme-icon">üåô</span>
            </button>
            <button class="refresh-btn" onclick="showPinModal()">Refresh Data</button>
        </div>
    </div>
</header>

<!-- PIN Modal -->
<div class="modal-overlay" id="pin-modal">
    <div class="modal">
        <h3>Enter PIN to refresh data</h3>
        <input type="password" id="pin-input" maxlength="4" placeholder="----" onkeydown="if(event.key==='Enter')triggerScrape()">
        <div class="modal-btns">
            <button class="btn btn-ghost" onclick="closePinModal()">Cancel</button>
            <button class="btn btn-primary" id="scrape-btn" onclick="triggerScrape()">Scrape</button>
        </div>
        <div class="modal-msg" id="pin-msg"></div>
    </div>
</div>

<div class="container">
    <div class="stats-bar" id="stats-bar" style="display:none;"></div>
    <div id="timestamp" class="timestamp"></div>
    <div class="tabs" id="tabs" style="display:none;">
        <button class="tab active" data-tab="matched" onclick="switchTab('matched')">
            Price Comparison <span class="badge" id="badge-matched">0</span>
        </button>
        <button class="tab" data-tab="all" onclick="switchTab('all')">
            All Products <span class="badge" id="badge-all">0</span>
        </button>
        <button class="tab" data-tab="unmatched" onclick="switchTab('unmatched')">
            Unique Products <span class="badge" id="badge-unmatched">0</span>
        </button>
    </div>
    <div id="content">
        <div class="loading"><div class="spinner"></div>Loading product data...</div>
    </div>
</div>

<script>
// ---------------------------------------------------------------------------
// State
// ---------------------------------------------------------------------------
let DATA = null;
let SUPPLIER_META = {}; // Will be loaded from database
let activeSuppliers = new Set();
let currentTab = 'matched';
let debounceTimer = null;
let matchCache = null;
let matchCacheKey = '';

// ---------------------------------------------------------------------------
// Matching logic (ported from Python)
// ---------------------------------------------------------------------------
const STOP_WORDS = new Set([
    'the','a','an','and','or','for','of','in','with','to','is','by','at','on',
    'all','new','free','per','mm','kg','ltr','litre','ml','pack','set','each',
    'pair','x','gst','excl','inc',
]);

function normalize(name) {
    name = name.toLowerCase().trim();
    name = name.replace(/[¬Æ‚Ñ¢¬©ÔøΩ\u0000-\u001f]/g, '');
    name = name.replace(/\s*\(.*?\)\s*/g, ' ');
    for (const sep of [' - ', ' ‚Äì ', ' ‚Äî ']) {
        const i = name.indexOf(sep);
        if (i > 10) name = name.substring(0, i);
    }
    return name.replace(/\s+/g, ' ').trim();
}

function tokenize(name) {
    let norm = normalize(name);

    // Only remove actual supplier retailer names (not brands)
    const supplierNames = ['kevmor', 'intafloors', 'gibbon', 'trade', 'marques',
                          'gluesntools', 'homely', 'bayset', 'floorking', 'mjs'];
    for (const supplier of supplierNames) {
        norm = norm.replace(new RegExp('\\b' + supplier + '\\b', 'g'), '');
    }

    // Normalize unit variations
    norm = norm.replace(/\blitres?\b/g, 'l');
    norm = norm.replace(/\bkilograms?\b/g, 'kg');
    norm = norm.replace(/\bgrams?\b/g, 'g');
    norm = norm.replace(/\bmetres?\b/g, 'm');
    norm = norm.replace(/\bmillimetres?\b/g, 'mm');
    norm = norm.replace(/\bcentimetres?\b/g, 'cm');

    const tokens = new Set(norm.match(/[a-z0-9]+/g) || []);
    STOP_WORDS.forEach(w => tokens.delete(w));
    return tokens;
}

function similarity(name1, name2) {
    const t1 = tokenize(name1);
    const t2 = tokenize(name2);
    if (!t1.size || !t2.size) return 0;
    let intersection = 0;
    t1.forEach(t => { if (t2.has(t)) intersection++; });
    const union = new Set([...t1, ...t2]).size;
    return intersection / union;
}

function matchProducts(supplierKeys, threshold) {
    const cacheKey = supplierKeys.sort().join(',') + ':' + threshold;
    if (matchCache && matchCacheKey === cacheKey) return matchCache;

    const allProducts = [];

    for (const key of supplierKeys) {
        const sup = DATA.suppliers[key];
        if (!sup) continue;
        for (const p of sup.products) {
            // Include all products - if it has a price, compare it
            allProducts.push({ ...p, _supplier: key, _tokens: tokenize(p.name) });
        }
    }

    // Group by matching - greedy approach
    const used = new Set();
    const groups = [];

    for (let i = 0; i < allProducts.length; i++) {
        if (used.has(i)) continue;
        const group = [{ idx: i, product: allProducts[i] }];
        used.add(i);

        for (let j = i + 1; j < allProducts.length; j++) {
            if (used.has(j)) continue;
            if (allProducts[j]._supplier === allProducts[i]._supplier) continue;

            const score = similarity(allProducts[i].name, allProducts[j].name);
            if (score >= threshold) {
                // Check this product matches the group well
                let matchesGroup = true;
                for (const member of group) {
                    if (allProducts[j]._supplier === member.product._supplier) {
                        matchesGroup = false;
                        break;
                    }
                }
                if (matchesGroup) {
                    group.push({ idx: j, product: allProducts[j], score });
                    used.add(j);
                }
            }
        }

        if (group.length > 1) {
            const avgScore = group.slice(1).reduce((s, g) => s + (g.score || 1), 0) / (group.length - 1);
            groups.push({
                products: group.map(g => g.product),
                score: avgScore,
            });
        }
    }

    // Unmatched (include excluded parts in unmatched list)
    const unmatched = [];
    for (let i = 0; i < allProducts.length; i++) {
        if (!used.has(i)) unmatched.push(allProducts[i]);
    }
    groups.sort((a, b) => b.score - a.score);

    const result = { groups, unmatched, allProducts };
    matchCache = result;
    matchCacheKey = cacheKey;
    return result;
}

// ---------------------------------------------------------------------------
// UI
// ---------------------------------------------------------------------------
function escHtml(t) {
    const d = document.createElement('div');
    d.textContent = t || '';
    return d.innerHTML;
}

function buildSupplierDropdown(supplierConfigs) {
    const menu = document.getElementById('supplier-menu');
    menu.innerHTML = ''; // Clear existing content

    for (const config of supplierConfigs) {
        const option = document.createElement('div');
        option.className = 'supplier-option';

        const checkbox = document.createElement('div');
        checkbox.className = 'supplier-checkbox checked';
        checkbox.setAttribute('data-supplier', config.key);

        const label = document.createElement('span');
        label.className = 'supplier-label';
        label.textContent = config.name;

        option.appendChild(checkbox);
        option.appendChild(label);

        // Add click handler
        option.addEventListener('click', (event) => {
            toggleSupplier(config.key, event);
        });

        menu.appendChild(option);
    }

    updateSupplierCount();
}

function toggleDropdown(event) {
    event.stopPropagation();
    const menu = document.getElementById('supplier-menu');
    menu.classList.toggle('active');
}

function toggleSupplier(key, event) {
    if (event) event.stopPropagation();

    if (activeSuppliers.has(key)) {
        if (activeSuppliers.size <= 1) return; // Must have at least 1
        activeSuppliers.delete(key);
    } else {
        activeSuppliers.add(key);
    }

    // Update checkbox UI
    const checkbox = document.querySelector(`.supplier-checkbox[data-supplier="${key}"]`);
    if (checkbox) {
        if (activeSuppliers.has(key)) {
            checkbox.classList.add('checked');
        } else {
            checkbox.classList.remove('checked');
        }
    }

    // Update button text
    updateSupplierCount();

    matchCache = null;
    renderAll();
}

function updateSupplierCount() {
    const count = activeSuppliers.size;
    const total = Object.keys(SUPPLIER_META).length;
    const countText = count === total ? `All Suppliers (${total})` : `${count} Supplier${count !== 1 ? 's' : ''}`;
    document.getElementById('supplier-count').textContent = countText;
}

// Close dropdown when clicking outside
document.addEventListener('click', (e) => {
    const dropdown = document.querySelector('.supplier-dropdown');
    const menu = document.getElementById('supplier-menu');
    if (dropdown && !dropdown.contains(e.target)) {
        menu.classList.remove('active');
    }
});

function debounceRender() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(renderAll, 250);
}

function updateThresholdLabel() {
    document.getElementById('threshold-label').textContent = document.getElementById('threshold').value + '%';
}

function switchTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');
    renderContent();
}

function renderAll() {
    if (!DATA) return;
    const keys = [...activeSuppliers];
    const threshold = document.getElementById('threshold').value / 100;
    const result = matchProducts(keys, threshold);
    renderStats(result, keys);
    renderContent();
}

function renderStats(result, keys) {
    const bar = document.getElementById('stats-bar');
    bar.style.display = 'flex';
    document.getElementById('tabs').style.display = 'flex';

    // Sort keys to put Gibbon first (if selected)
    const sortedKeys = [...keys].sort((a, b) => {
        if (a === 'gibbon') return -1;
        if (b === 'gibbon') return 1;
        return 0;
    });

    let html = '';
    for (const key of sortedKeys) {
        const sup = DATA.suppliers[key];
        const meta = SUPPLIER_META[key];
        const withPrice = sup.products.filter(p => p.price).length;
        html += `<div class="stat">
            <div class="stat-value" style="color:${meta.color}">${sup.products.length}</div>
            <div class="stat-label">${meta.name} (${withPrice} priced)</div>
        </div>`;
    }
    html += `<div class="stat">
        <div class="stat-value" style="color:var(--accent)">${result.groups.length}</div>
        <div class="stat-label">Matched Groups</div>
    </div>`;
    bar.innerHTML = html;

    if (DATA.timestamp) {
        const date = new Date(DATA.timestamp);
        const now = new Date();
        const hoursSince = Math.floor((now - date) / (1000 * 60 * 60));
        const timeAgo = hoursSince < 1 ? 'Less than 1 hour ago' :
                       hoursSince === 1 ? '1 hour ago' :
                       hoursSince < 24 ? `${hoursSince} hours ago` :
                       `${Math.floor(hoursSince / 24)} days ago`;

        const statusBadge = DATA.scrapeStatus === 'success' || !DATA.scrapeStatus
            ? '<span class="scrape-status status-success">‚úì Success</span>'
            : '<span class="scrape-status status-error">‚ö† Warning</span>';

        document.getElementById('timestamp').innerHTML = `
            <span class="timestamp-icon">üïí</span>
            <span class="timestamp-text">
                <span class="timestamp-label">Last Updated:</span>
                <span class="timestamp-value">${date.toLocaleString()} (${timeAgo})</span>
                ${statusBadge}
            </span>
        `;
    }

    const search = document.getElementById('search').value.toLowerCase();
    const filtered = filterGroups(result.groups, search);
    const filteredUnmatched = filterProducts(result.unmatched, search);

    document.getElementById('badge-matched').textContent = filtered.length;
    document.getElementById('badge-all').textContent = result.allProducts.length;
    document.getElementById('badge-unmatched').textContent = filteredUnmatched.length;
}

function filterGroups(groups, search) {
    if (!search) return groups;
    return groups.filter(g => g.products.some(p => p.name.toLowerCase().includes(search)));
}

function filterProducts(products, search) {
    if (!search) return products;
    return products.filter(p => p.name.toLowerCase().includes(search));
}

function renderContent() {
    const el = document.getElementById('content');
    if (!DATA) return;

    const keys = [...activeSuppliers];
    const threshold = document.getElementById('threshold').value / 100;
    const result = matchProducts(keys, threshold);
    const search = document.getElementById('search').value.toLowerCase();

    if (currentTab === 'matched') {
        renderComparisons(el, filterGroups(result.groups, search), keys);
    } else if (currentTab === 'all') {
        renderAllProducts(el, filterProducts(result.allProducts, search));
    } else {
        renderAllProducts(el, filterProducts(result.unmatched, search));
    }
}

function renderComparisons(el, groups, keys) {
    if (!groups.length) {
        el.innerHTML = `<div class="empty-state"><h2>No Matched Products</h2><p>Try lowering the match threshold, enabling more suppliers, or broadening your search.</p></div>`;
        return;
    }

    // Sort keys to put Gibbon first (if selected)
    const sortedKeys = [...keys].sort((a, b) => {
        if (a === 'gibbon') return -1;
        if (b === 'gibbon') return 1;
        return 0;
    });

    // Build matrix-style header: # | Product | Supplier1 | Supplier2 | ... | Savings | Match
    let headerHtml = '<th style="width:3%;min-width:30px">#</th>';
    headerHtml += '<th style="width:25%;min-width:200px;position:sticky;left:0;background:var(--surface2);z-index:11">Product</th>';

    for (const key of sortedKeys) {
        const meta = SUPPLIER_META[key];
        const gibbonStyle = key === 'gibbon' ? 'background:rgba(255,243,178,0.15);' : '';
        headerHtml += `<th style="min-width:100px;color:${meta.color};text-align:center;${gibbonStyle}">${meta.name}</th>`;
    }
    headerHtml += '<th style="min-width:100px;text-align:center">Savings</th><th style="min-width:80px;text-align:center">Match</th>';

    let html = `<div class="table-wrapper"><table><thead><tr>${headerHtml}</tr></thead><tbody>`;

    for (let gi = 0; gi < groups.length; gi++) {
        const g = groups[gi];

        // Map products by supplier
        const bySupplier = {};
        for (const p of g.products) {
            bySupplier[p._supplier] = p;
        }

        // Find best price
        const prices = g.products.filter(p => p.price).map(p => ({ supplier: p._supplier, price: p.price }));
        prices.sort((a, b) => a.price - b.price);
        const bestPrice = prices.length ? prices[0].price : null;
        const bestSupplier = prices.length ? prices[0].supplier : null;
        const worstPrice = prices.length > 1 ? prices[prices.length - 1].price : null;

        let savingsHtml = '<span class="price-na">-</span>';
        if (bestPrice && worstPrice && bestPrice < worstPrice) {
            const saving = worstPrice - bestPrice;
            const pct = ((saving / worstPrice) * 100).toFixed(1);
            savingsHtml = `<div class="diff-amount" style="color:var(--green)">$${saving.toFixed(2)}</div>
                <div class="diff-pct">${pct}% saved</div>`;
        }

        const scoreClass = g.score >= 0.7 ? 'score-high' : g.score >= 0.5 ? 'score-medium' : 'score-low';

        // Get a representative product for display (prefer one with image)
        const displayProduct = g.products.find(p => p.image) || g.products[0];

        html += `<tr>`;
        html += `<td style="color:var(--text-muted);font-size:0.75rem">${gi + 1}</td>`;

        // Product column (sticky left)
        html += `<td style="position:sticky;left:0;background:var(--surface);z-index:1">
            <div class="product-cell">
                ${displayProduct.image ? `<img class="product-img" src="${escHtml(displayProduct.image)}" alt="" loading="lazy" onerror="this.style.display='none'">` : ''}
                <div>
                    <div class="product-name"><a href="${escHtml(displayProduct.url)}" target="_blank" rel="noopener">${escHtml(displayProduct.name)}</a></div>
                    <div class="product-category">${escHtml(displayProduct.category || '')}</div>
                </div>
            </div>
        </td>`;

        // Price columns for each supplier (use sortedKeys to maintain order)
        for (const key of sortedKeys) {
            const p = bySupplier[key];
            const gibbonBg = key === 'gibbon' ? 'background:rgba(255,243,178,0.2);' : '';

            if (p) {
                const isBest = p.price && p._supplier === bestSupplier && prices.length > 1;
                const isWorst = p.price && worstPrice && p.price === worstPrice && prices.length > 1 && bestPrice < worstPrice;
                const priceClass = isBest ? 'price-cheaper' : isWorst ? 'price-dearer' : '';

                if (p.price) {
                    html += `<td style="text-align:center;${gibbonBg}"><a href="${escHtml(p.url)}" target="_blank" rel="noopener" style="text-decoration:none"><span class="price ${priceClass}">$${p.price.toFixed(2)}</span></a></td>`;
                } else {
                    html += `<td style="text-align:center;${gibbonBg}"><span class="price-na">${escHtml(p.price_display || 'N/A')}</span></td>`;
                }
            } else {
                html += `<td style="text-align:center;${gibbonBg}"><span class="price-na" style="font-size:0.78rem">-</span></td>`;
            }
        }

        html += `<td class="diff-cell" style="text-align:center">${savingsHtml}</td>`;
        html += `<td style="text-align:center"><span class="match-score ${scoreClass}">${Math.round(g.score * 100)}%</span></td>`;
        html += `</tr>`;
    }

    html += '</tbody></table></div>';
    el.innerHTML = html;
}

function renderAllProducts(el, products) {
    if (!products.length) {
        el.innerHTML = `<div class="empty-state"><h2>No Products Found</h2><p>Try adjusting your search or supplier selection.</p></div>`;
        return;
    }

    let html = `<div class="table-wrapper"><table><thead><tr>
        <th style="width:5%">#</th>
        <th style="width:45%">Product</th>
        <th style="width:15%">Price</th>
        <th style="width:20%">Category</th>
        <th style="width:15%">Supplier</th>
    </tr></thead><tbody>`;

    for (let i = 0; i < products.length; i++) {
        const p = products[i];
        const meta = SUPPLIER_META[p._supplier] || { name: p.source || '?', cssClass: '' };
        const isPartBadge = p._isReplacementPart ? '<span style="background:rgba(245,158,11,0.2);color:var(--orange);padding:0.1rem 0.4rem;border-radius:3px;font-size:0.68rem;font-weight:600;margin-left:0.3rem">PART</span>' : '';

        html += `<tr>
            <td style="color:var(--text-muted);font-size:0.75rem">${i + 1}</td>
            <td>
                <div class="product-cell">
                    ${p.image ? `<img class="product-img" src="${escHtml(p.image)}" alt="" loading="lazy" onerror="this.style.display='none'">` : ''}
                    <div>
                        <div class="product-name"><a href="${escHtml(p.url)}" target="_blank" rel="noopener">${escHtml(p.name)}</a>${isPartBadge}</div>
                    </div>
                </div>
            </td>
            <td><span class="price">${p.price ? '$' + p.price.toFixed(2) : '<span class="price-na">' + escHtml(p.price_display || 'N/A') + '</span>'}</span></td>
            <td class="product-category">${escHtml(p.category || '')}</td>
            <td><span class="source-tag ${meta.cssClass}">${escHtml(meta.name)}</span></td>
        </tr>`;
    }

    html += '</tbody></table></div>';
    el.innerHTML = html;
}

// ---------------------------------------------------------------------------
// Supabase config
// ---------------------------------------------------------------------------
const SUPABASE_URL = 'https://ualogaryduudrnozmoyx.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhbG9nYXJ5ZHV1ZHJub3ptb3l4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NjQyOTcsImV4cCI6MjA4NjM0MDI5N30.qdsd1YKj8VjafV1lxA9p0iqSONfH5TDQyi41ljSYFhs';

const SB_HEADERS = {
    'apikey': SUPABASE_ANON_KEY,
    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
};

async function sbFetch(path) {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, { headers: SB_HEADERS });
    if (!res.ok) throw new Error(`Supabase ${res.status}: ${await res.text()}`);
    return res.json();
}

// ---------------------------------------------------------------------------
// Load data from Supabase
// ---------------------------------------------------------------------------
async function loadData() {
    try {
        // Fetch products, scrape logs, and supplier config in parallel
        let products, logs, supplierConfigs;
        try {
            [products, logs, supplierConfigs] = await Promise.all([
                sbFetch('products?select=*&order=name.asc'),
                sbFetch('scrape_log?select=*&order=completed_at.desc&limit=3'),
                sbFetch('supplier_config?select=*&enabled=eq.true&order=name.asc'),
            ]);
        } catch (e) {
            console.warn('Failed to load supplier_config, using defaults:', e);
            [products, logs] = await Promise.all([
                sbFetch('products?select=*&order=name.asc'),
                sbFetch('scrape_log?select=*&order=completed_at.desc&limit=3'),
            ]);
            supplierConfigs = [];
        }

        // Build SUPPLIER_META from database or use hardcoded defaults
        SUPPLIER_META = {};
        activeSuppliers.clear();

        if (supplierConfigs && supplierConfigs.length > 0) {
            // Use database config
            for (const config of supplierConfigs) {
                SUPPLIER_META[config.key] = {
                    name: config.name,
                    color: config.color || '#3b82f6',
                    cssClass: `source-${config.key}`
                };
                activeSuppliers.add(config.key);
            }
            buildSupplierDropdown(supplierConfigs);
        } else {
            // Fallback to hardcoded suppliers
            console.info('Using hardcoded supplier list');
            const defaultSuppliers = [
                { key: 'kevmor', name: 'Kevmor', color: '#f97316' },
                { key: 'intafloors', name: 'Intafloors', color: '#06b6d4' },
                { key: 'gibbon', name: 'Gibbon Trade', color: '#22c55e' },
                { key: 'marques', name: 'Marques', color: '#a855f7' },
                { key: 'floortrade', name: 'Floor Trade', color: '#ec4899' },
                { key: 'gluesntools', name: 'Glues N Tools', color: '#eab308' },
                { key: 'homely', name: 'Homely', color: '#14b8a6' },
            ];
            for (const config of defaultSuppliers) {
                SUPPLIER_META[config.key] = {
                    name: config.name,
                    color: config.color,
                    cssClass: `source-${config.key}`
                };
                activeSuppliers.add(config.key);
            }
            buildSupplierDropdown(defaultSuppliers);
        }

        // Group by source into supplier structure
        const bySource = {};
        for (const p of products) {
            if (!bySource[p.source]) bySource[p.source] = [];
            bySource[p.source].push({
                name: p.name,
                price: p.price ? parseFloat(p.price) : null,
                price_display: p.price_display || (p.price ? `$${parseFloat(p.price).toFixed(2)} GST excl.` : 'Contact for Price'),
                url: p.url || '',
                image: p.image || '',
                category: p.category || '',
                sku: p.sku || '',
            });
        }

        // Map source to suppliers (source field matches supplier key)
        // Initialize all suppliers from SUPPLIER_META with empty arrays
        const suppliers = {};
        for (const key of Object.keys(SUPPLIER_META)) {
            suppliers[key] = { products: [] };
        }
        // Then populate with actual products
        for (const [src, prods] of Object.entries(bySource)) {
            if (suppliers[src]) {
                suppliers[src].products = prods;
            } else {
                // Product source not in SUPPLIER_META (shouldn't happen, but handle it)
                suppliers[src] = { products: prods };
            }
        }

        const latestLog = logs.length ? logs[0] : null;

        DATA = {
            timestamp: latestLog ? latestLog.completed_at : new Date().toISOString(),
            scrapeStatus: latestLog ? latestLog.status : 'success',
            suppliers,
        };

        renderAll();
    } catch (e) {
        console.error('Supabase load error:', e);
        // Fallback: try loading from static data.json
        try {
            const res = await fetch('data.json');
            DATA = await res.json();
            renderAll();
        } catch (e2) {
            document.getElementById('content').innerHTML =
                `<div class="empty-state"><h2>Failed to load data</h2><p>${escHtml(e.message)}</p><p style="font-size:0.8rem;margin-top:0.5rem">Falling back to static data also failed.</p></div>`;
        }
    }
}

// ---------------------------------------------------------------------------
// PIN-protected scrape trigger
// ---------------------------------------------------------------------------
function showPinModal() {
    document.getElementById('pin-modal').classList.add('active');
    document.getElementById('pin-input').value = '';
    document.getElementById('pin-msg').textContent = '';
    setTimeout(() => document.getElementById('pin-input').focus(), 100);
}

function closePinModal() {
    document.getElementById('pin-modal').classList.remove('active');
}

async function triggerScrape() {
    const pin = document.getElementById('pin-input').value;
    const msg = document.getElementById('pin-msg');
    const btn = document.getElementById('scrape-btn');

    if (!pin || pin.length < 4) {
        msg.className = 'modal-msg msg-err';
        msg.textContent = 'Enter your 4-digit PIN';
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Triggering...';
    msg.className = 'modal-msg';
    msg.textContent = '';

    try {
        const res = await fetch('/api/trigger-scrape', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pin }),
        });
        const data = await res.json();

        if (res.ok && data.success) {
            msg.className = 'modal-msg msg-ok';
            msg.textContent = data.message;
            setTimeout(closePinModal, 3000);
        } else {
            msg.className = 'modal-msg msg-err';
            msg.textContent = data.error || 'Failed';
        }
    } catch (e) {
        msg.className = 'modal-msg msg-err';
        msg.textContent = 'Network error: ' + e.message;
    } finally {
        btn.disabled = false;
        btn.textContent = 'Scrape';
    }
}

// Close modal on overlay click
document.getElementById('pin-modal').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) closePinModal();
});

// ---------------------------------------------------------------------------
// Theme toggle
// ---------------------------------------------------------------------------
function toggleTheme() {
    const html = document.documentElement;
    const currentTheme = html.getAttribute('data-theme');
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';

    html.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeIcon(newTheme);
}

function updateThemeIcon(theme) {
    const icon = document.getElementById('theme-icon');
    icon.textContent = theme === 'light' ? '‚òÄÔ∏è' : 'üåô';
}

function initTheme() {
    const savedTheme = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);
}

// Initialize theme before page loads
initTheme();

loadData();
</script>
</body>
</html>
